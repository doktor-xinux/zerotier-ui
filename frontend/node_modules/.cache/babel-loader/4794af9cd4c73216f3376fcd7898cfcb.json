{"ast":null,"code":"import _objectSpread from\"/mnt/Datengrab/python/Zero-tier/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _asyncToGenerator from\"/mnt/Datengrab/python/Zero-tier/frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _toConsumableArray from\"/mnt/Datengrab/python/Zero-tier/frontend/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _slicedToArray from\"/mnt/Datengrab/python/Zero-tier/frontend/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _regeneratorRuntime from\"/mnt/Datengrab/python/Zero-tier/frontend/node_modules/@babel/runtime/regenerator/index.js\";import{Accordion,AccordionDetails,AccordionSummary,Button,Divider,Grid,Hidden,Snackbar,Typography}from\"@material-ui/core\";import ExpandMoreIcon from\"@material-ui/icons/ExpandMore\";import CodeMirror from\"@uiw/react-codemirror\";import\"codemirror/theme/3024-day.css\";import{compile}from\"external/RuleCompiler\";import debounce from\"lodash/debounce\";import{useState}from\"react\";import API from\"utils/API\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";function NetworkRules(_ref){var network=_ref.network,callback=_ref.callback;var _useState=useState(null),_useState2=_slicedToArray(_useState,2),editor=_useState2[0],setEditor=_useState2[1];var _useState3=useState({rules:_toConsumableArray(network.config.rules),capabilities:_toConsumableArray(network.config.capabilities),tags:_toConsumableArray(network.config.tags)}),_useState4=_slicedToArray(_useState3,2),flowData=_useState4[0],setFlowData=_useState4[1];var _useState5=useState({tagsByName:network.tagsByName||{},capabilitiesByName:network.capabilitiesByName||{}}),_useState6=_slicedToArray(_useState5,2),tagCapByNameData=_useState6[0],setTagCapByNameData=_useState6[1];var _useState7=useState([]),_useState8=_slicedToArray(_useState7,2),errors=_useState8[0],setErrors=_useState8[1];var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),snackbarOpen=_useState10[0],setSnackbarOpen=_useState10[1];var saveChanges=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var req,timer;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!editor){_context.next=9;break;}_context.next=3;return API.post(\"/network/\"+network[\"config\"][\"id\"],_objectSpread({config:_objectSpread({},flowData),rulesSource:editor.getValue()},tagCapByNameData));case 3:req=_context.sent;console.log(\"Action\",req);setSnackbarOpen(true);timer=setTimeout(function(){setSnackbarOpen(false);},1500);callback();return _context.abrupt(\"return\",function(){return clearTimeout(timer);});case 9:case\"end\":return _context.stop();}}},_callee);}));return function saveChanges(){return _ref2.apply(this,arguments);};}();var onChange=debounce(function(event){var src=event.getValue();setEditor(event);var rules=[],caps={},tags={};var res=compile(src,rules,caps,tags);if(!res){var capabilitiesByName={};for(var key in caps){capabilitiesByName[key]=caps[key].id;}var tagsByName=_objectSpread({},tags);for(var _key in tags){tags[_key]={id:tags[_key].id,default:tags[_key].default};}setFlowData({rules:[].concat(rules),capabilities:_toConsumableArray(Object.values(caps)),tags:_toConsumableArray(Object.values(tags))});setTagCapByNameData({tagsByName:tagsByName,capabilitiesByName:capabilitiesByName});setErrors([]);}else{setErrors(res);}},100);return/*#__PURE__*/_jsxs(Accordion,{children:[/*#__PURE__*/_jsx(AccordionSummary,{expandIcon:/*#__PURE__*/_jsx(ExpandMoreIcon,{}),children:/*#__PURE__*/_jsx(Typography,{children:\"Flow Rules\"})}),/*#__PURE__*/_jsxs(AccordionDetails,{children:[/*#__PURE__*/_jsx(CodeMirror,{value:network[\"rulesSource\"],onChange:onChange,options:{tabSize:2,lineWrapping:true}}),/*#__PURE__*/_jsx(Hidden,{mdDown:true,children:/*#__PURE__*/_jsx(\"div\",{children:/*#__PURE__*/_jsx(CodeMirror,{value:JSON.stringify(flowData,null,2),width:\"100%\",height:\"50%\",options:{theme:\"3024-day\",readOnly:true,lineNumbers:false,lineWrapping:true}})})}),/*#__PURE__*/_jsx(Divider,{}),/*#__PURE__*/_jsx(Grid,{item:true,style:{margin:\"1%\",display:\"block\",overflowWrap:\"break-word\",width:\"250px\"},children:!!errors.length?/*#__PURE__*/_jsx(Typography,{color:\"error\",children:\"[\"+errors[0]+\":\"+errors[1]+\"] \"+errors[2]}):/*#__PURE__*/_jsx(Button,{variant:\"contained\",color:\"primary\",onClick:saveChanges,children:\"Save Changes\"})}),/*#__PURE__*/_jsx(Snackbar,{open:snackbarOpen,anchorOrigin:{vertical:\"top\",horizontal:\"center\"},message:\"Saved\"})]})]});}export default NetworkRules;","map":{"version":3,"names":["Accordion","AccordionDetails","AccordionSummary","Button","Divider","Grid","Hidden","Snackbar","Typography","ExpandMoreIcon","CodeMirror","compile","debounce","useState","API","NetworkRules","network","callback","editor","setEditor","rules","config","capabilities","tags","flowData","setFlowData","tagsByName","capabilitiesByName","tagCapByNameData","setTagCapByNameData","errors","setErrors","snackbarOpen","setSnackbarOpen","saveChanges","post","rulesSource","getValue","req","console","log","timer","setTimeout","clearTimeout","onChange","event","src","caps","res","key","id","default","Object","values","tabSize","lineWrapping","JSON","stringify","theme","readOnly","lineNumbers","margin","display","overflowWrap","width","length","vertical","horizontal"],"sources":["/mnt/Datengrab/python/Zero-tier/frontend/src/components/NetworkRules/NetworkRules.jsx"],"sourcesContent":["import {\n  Accordion,\n  AccordionDetails,\n  AccordionSummary,\n  Button,\n  Divider,\n  Grid,\n  Hidden,\n  Snackbar,\n  Typography,\n} from \"@material-ui/core\";\nimport ExpandMoreIcon from \"@material-ui/icons/ExpandMore\";\nimport CodeMirror from \"@uiw/react-codemirror\";\nimport \"codemirror/theme/3024-day.css\";\nimport { compile } from \"external/RuleCompiler\";\nimport debounce from \"lodash/debounce\";\nimport { useState } from \"react\";\nimport API from \"utils/API\";\n\nfunction NetworkRules({ network, callback }) {\n  const [editor, setEditor] = useState(null);\n  const [flowData, setFlowData] = useState({\n    rules: [...network.config.rules],\n    capabilities: [...network.config.capabilities],\n    tags: [...network.config.tags],\n  });\n  const [tagCapByNameData, setTagCapByNameData] = useState({\n    tagsByName: network.tagsByName || {},\n    capabilitiesByName: network.capabilitiesByName || {},\n  });\n  const [errors, setErrors] = useState([]);\n  const [snackbarOpen, setSnackbarOpen] = useState(false);\n\n  const saveChanges = async () => {\n    if (editor) {\n      const req = await API.post(\"/network/\" + network[\"config\"][\"id\"], {\n        config: { ...flowData },\n        rulesSource: editor.getValue(),\n        ...tagCapByNameData,\n      });\n      console.log(\"Action\", req);\n      setSnackbarOpen(true);\n      const timer = setTimeout(() => {\n        setSnackbarOpen(false);\n      }, 1500);\n\n      callback();\n\n      return () => clearTimeout(timer);\n    }\n  };\n\n  const onChange = debounce((event) => {\n    const src = event.getValue();\n    setEditor(event);\n    let rules = [],\n      caps = {},\n      tags = {};\n    const res = compile(src, rules, caps, tags);\n    if (!res) {\n      let capabilitiesByName = {};\n      for (var key in caps) {\n        capabilitiesByName[key] = caps[key].id;\n      }\n\n      let tagsByName = { ...tags };\n      for (let key in tags) {\n        tags[key] = { id: tags[key].id, default: tags[key].default };\n      }\n\n      setFlowData({\n        rules: [...rules],\n        capabilities: [...Object.values(caps)],\n        tags: [...Object.values(tags)],\n      });\n\n      setTagCapByNameData({\n        tagsByName: tagsByName,\n        capabilitiesByName: capabilitiesByName,\n      });\n      setErrors([]);\n    } else {\n      setErrors(res);\n    }\n  }, 100);\n\n  return (\n    <Accordion>\n      <AccordionSummary expandIcon={<ExpandMoreIcon />}>\n        <Typography>Flow Rules</Typography>\n      </AccordionSummary>\n      <AccordionDetails>\n        {/*   Important note: value in CodeMirror instance means INITAIL VALUE\n              or it could be used to replace editor state with the new value.\n              No need to update on every user character input\n        */}\n        <CodeMirror\n          value={network[\"rulesSource\"]}\n          onChange={onChange}\n          options={{ tabSize: 2, lineWrapping: true }}\n        />\n        <Hidden mdDown>\n          <div>\n            <CodeMirror\n              value={JSON.stringify(flowData, null, 2)}\n              width=\"100%\"\n              height=\"50%\"\n              options={{\n                theme: \"3024-day\",\n                readOnly: true,\n                lineNumbers: false,\n                lineWrapping: true,\n              }}\n            />\n          </div>\n        </Hidden>\n        <Divider />\n        <Grid\n          item\n          style={{\n            margin: \"1%\",\n            display: \"block\",\n            overflowWrap: \"break-word\",\n            width: \"250px\",\n          }}\n        >\n          {!!errors.length ? (\n            <Typography color=\"error\">\n              {\"[\" + errors[0] + \":\" + errors[1] + \"] \" + errors[2]}\n            </Typography>\n          ) : (\n            <Button variant=\"contained\" color=\"primary\" onClick={saveChanges}>\n              Save Changes\n            </Button>\n          )}\n        </Grid>\n        <Snackbar\n          open={snackbarOpen}\n          anchorOrigin={{\n            vertical: \"top\",\n            horizontal: \"center\",\n          }}\n          message=\"Saved\"\n        />\n      </AccordionDetails>\n    </Accordion>\n  );\n}\n\nexport default NetworkRules;\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}